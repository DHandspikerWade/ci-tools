variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2
  DOCKER_REGISTRY: https://index.docker.io/v1/
  EXTRA_OPTIONS: '--pull'

stages:
  - base
  - depends

.build_template: &build_template
  image: docker:18
  stage: depends
  services:
    - docker:dind
  script:
    - docker version
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin "$DOCKER_REGISTRY"
    - export IMAGE_NAME="${IMAGE_NAME}:${TAG_NAME}"
    - docker pull "$IMAGE_NAME" || true
    - docker build --cache-from "$IMAGE_NAME" $EXTRA_OPTIONS -t "$IMAGE_NAME" -f $DOCKER_FILE .
    - docker push "$IMAGE_NAME"

build_base:
  <<: *build_template
  stage: base
  variables:
    EXTRA_OPTIONS: '-t handspiker2/ci-tools:latest'
    IMAGE_NAME: handspiker2/ci-tools:base
    DOCKER_FILE: base.Dockerfile
  script:
    - docker version
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USER" --password-stdin "$DOCKER_REGISTRY"
    - docker pull ubuntu:18.04
    - docker pull "$IMAGE_NAME" || true
    - docker build --cache-from "$IMAGE_NAME" $EXTRA_OPTIONS -t "$IMAGE_NAME" -f $DOCKER_FILE .
    - docker push "$IMAGE_NAME"
    - docker push handspiker2/ci-tools:latest
  only:
    refs:
      - master
    changes:
      - '.gitlab-ci.yml'
      - base.Dockerfile

build_docker:
  <<: *build_template
  stage: depends
  variables: 
    TAG_NAME: docker
    DOCKER_FILE: docker.Dockerfile
  only:
    refs:
      - master
    changes:
      - '.gitlab-ci.yml'
      - base.Dockerfile
      - docker.Dockerfile

.build_php: &php_template
  <<: *build_template
  stage: depends
  variables: &php_variables
    PHP_VERSION: ''
    DOCKER_FILE: php.Dockerfile 
    IMAGE_NAME: handspiker2/ci-tools
  only:
    refs:
      - master
    changes:
      - '.gitlab-ci.yml'
      - base.Dockerfile
      - php.Dockerfile

php7.2:
  <<: *php_template
  variables:
    <<: *php_variables
    PHP_VERSION: '7.2.17'
    TAG_NAME: 'php7.2'

php7.1:
  <<: *php_template
  variables:
    <<: *php_variables
    PHP_VERSION: '7.1.28'
    TAG_NAME: 'php7.1'

php5.6:
  <<: *php_template
  variables:
    <<: *php_variables
    PHP_VERSION: '5.6.40'
    TAG_NAME: 'php5.6'

